function Checkpoint(_inDate,_outDate){this["in"]=_inDate||now(),this.out=_outDate,this.restHour=[],this.toMoment=function(){this["in"]=moment(this["in"]),this.out=moment(this.out)},this.addRestHour=function(_rest){this.restHour.push(_rest)},this.totalRestHour=function(){return this.restHour.length?1==this.restHour.length?dateDiff(this.restHour[0]["in"],this.restHour[0].out).total.milisecond:this.restHour.reduce(function(total,x){return total+dateDiff(x["in"],x.out).total.milisecond},0):0},this.totalWorkHourFull=function(){return moment(this.out).diff(moment(this["in"]))},this.totalWorkHour=function(){var moments=this["in"];return moments.add(this.totalRestHour(),"ms"),dateDiff(moments,this.out)}}function StateTransaction(_serial,_name,_exibitionName,_message,_action){this._id=_serial||"",this.destionation=[],this.name=_name||"",this.exibitionName=_exibitionName||"",this.message=_message||"",this.action=_action||function(){}}function StateNode(_stateStatus){this.status=_stateStatus||StateStatus.Middle,this.pair={},this.transactions=[],this.addDestionationNode=function(_pair){this.pair[_pair[1]._id]=_pair[0],this.transactions.push(_pair[1])},this.applyTransaction=function(_trans){return _trans.action(),this.pair[_trans._id]}}function now(){return moment()}function dateDiff(dateStart,dateEnd){var momentStart=moment(dateStart),momentEnd=moment(dateEnd),total={day:Math.abs(momentEnd.diff(momentStart,"days")),hour:Math.abs(momentEnd.diff(momentStart,"hour")),minute:Math.abs(momentEnd.diff(momentStart,"minute")),second:Math.abs(momentEnd.diff(momentStart,"second")),milisecond:Math.abs(momentEnd.diff(momentStart,"milisecond"))};return{total:total,day:total.day,hour:Math.abs(total.hour-24*total.day),minute:Math.abs(total.minute-60*total.hour),second:Math.abs(total.second-60*total.minute),milisecond:Math.abs(total.milisecond-1e3*total.second)}}angular.module("horas-app",["ngRoute"]),angular.module("horas-app").config(["fileDbProvider","dbConst",function(fileDbProvider,dbConst){fileDbProvider.setConnection(require("file-db")),fileDbProvider.setDirectory(dbConst.directory)}]),angular.module("horas-app").config(["$routeProvider","$locationProvider",function($routeProvider,$locationProvider){$locationProvider.html5Mode(!0),$routeProvider.when("/hour",{templateUrl:"app/view/hour.html",controller:"hourCtrl"}).otherwise({redirectTo:"/hour"})}]),angular.module("horas-app").config(["serialGeneratorProvider",function(serialGeneratorProvider){serialGeneratorProvider.setLength(15)}]),angular.module("horas-app").constant("viewPath",{directive:"app/view/directive/",route:"app/view/"}),angular.module("horas-app").constant("dbConst",{directory:"data/",checkpoint:{collection:"checkpoint"}}),angular.module("horas-app").controller("hourCtrl",["$scope","hourStateMachine","toastr",function($scope,hourStateMachine,toastr){var _stateMachine=hourStateMachine.createStateMachine(),checkpoint=null;$scope.resumeDay=null,$scope.clickTransaction=function(transaction){toastr.info(transaction.message,transaction.name),$scope.currentState=$scope.currentState.applyTransaction(transaction),$scope.currentState.status==StateStatus.End?(checkpoint=hourStateMachine.getCheckpoint(),$scope.resumeDay=checkpoint.totalWorkHour(),hourStateMachine.saveCheckpoint(checkpoint)):(checkpoint=null,$scope.resumeDay=null)},$scope.currentState=_stateMachine.filter(function(x){return x.status==StateStatus.Initial})[0]}]),angular.module("horas-app").directive("painelHour",["viewPath","$interval",function(viewPath,$interval){return{templateUrl:viewPath.directive+"painelHour.html",transclude:!1,scope:{},link:function(scope,element,attr){var time=new Date;scope.time=time,$interval(function(){time=scope.time,time.setSeconds(time.getSeconds()+1),scope.time=time},1e3)}}}]),angular.module("horas-app").directive("toolbarWindow",["viewPath",function(viewPath){return{transclude:!1,templateUrl:viewPath.directive+"toolbarWindow.html",restrict:"E",scope:{},link:function(scope,element,attrs,ctrl){function closeApplication(){win.close()}function minimizeApplication(){win.minimize()}var gui=require("nw.gui"),win=gui.Window.get();scope.closeApplication=closeApplication,scope.minimizeApplication=minimizeApplication}}}]);var StateStatus={Initial:1,End:2,Middle:3};angular.module("horas-app").factory("checkpointDao",["fileDb","dbConst",function(fileDb,dbConst){var _collection=dbConst.checkpoint.collection,_save=function(data){fileDb.exec(function(db){db.use(_collection).save(data).exec()})},_getAll=function(){fileDb.exec(function(db){db.use(_collection).find().exec(function(err,data){console.log(data)})})};return{save:_save,getAll:_getAll}}]),angular.module("horas-app").provider("fileDb",function(){function _do(_cb){_fdb.open(_dir,function(err,db){_cb(db)})}var _fdb=null,_dir=null;this.setConnection=function(connection){_fdb=connection},this.setDirectory=function(d){_dir=d},this.$get=function(){return{exec:_do}}}),angular.module("horas-app").service("hourStateMachine",["serialGenerator","checkpointDao",function(serialGenerator,checkpointDao){var self=this;this.arrivalHour=null,this.leaveHour=null,this.intervalHour=[],this.intervalHourLeave=null,this.createStateMachine=function(){var _arrivalTransaction=new StateTransaction(serialGenerator.generate(),"Chegada","Chegada","Bem vindo, bom trabalho!",function(){self.arrivalHour=now()}),_leaveTransaction=new StateTransaction(serialGenerator.generate(),"Saída","Saída","Obrigado! Tenha um bom descanço!",function(){self.leaveHour=now()}),_goLunchTransaction=new StateTransaction(serialGenerator.generate(),"Intervalo","Intervalo","Descance, estaremos lhe aguardando",function(){self.intervalHourLeave=now()}),_goBackLunchTransaction=new StateTransaction(serialGenerator.generate(),"Voltar do Intervalo","Voltar do Intervalo","Olá!",function(){self.intervalHour.push({"in":self.intervalHourLeave,out:now()}),self.intervalHourLeave=null}),_arrivalState=new StateNode(StateStatus.Initial),_workingState=new StateNode(StateStatus.Middle),_lunchingState=new StateNode(StateStatus.Middle),_leaveState=new StateNode(StateStatus.End);return _arrivalState.addDestionationNode([_workingState,_arrivalTransaction]),_workingState.addDestionationNode([_lunchingState,_goLunchTransaction]),_workingState.addDestionationNode([_leaveState,_leaveTransaction]),_lunchingState.addDestionationNode([_workingState,_goBackLunchTransaction]),[_arrivalState,_workingState,_lunchingState,_leaveState]},this.getCheckpoint=function(){var check=new Checkpoint(this.arrivalHour,this.leaveHour);return this.intervalHour.forEach(function(x){check.addRestHour(x)}),check},this.saveCheckpoint=function(checkpoint){checkpointDao.save(checkpoint),checkpointDao.getAll()}}]),angular.module("horas-app").provider("serialGenerator",function(){var _length=10;this.getLength=function(){return _length},this.setLength=function(length){_length=length},this.$get=function(){return{generate:function(){for(var serial="";serial.length<_length;)serial+=String.fromCharCode(Math.floor(64*Math.random())+32);return serial}}}}),angular.module("horas-app").factory("toastr",function(){function createToaStrFunction(status){return function(message,title){var toastrOpt=angular.copy(defaults,obj.options);toastr.options=toastrOpt,toastr[status](message,title)}}var status=["info","success","warning","error"],defaults={closeButton:!1,debug:!1,newestOnTop:!1,progressBar:!1,positionClass:"toast-bottom-right",preventDuplicates:!1,onclick:null,showDuration:"300",hideDuration:"1000",timeOut:"5000",extendedTimeOut:"1000",showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut"},obj={setOption:function(options){this.options=options}};return status.forEach(function(i){obj.options=obj.options||{},obj[i]=createToaStrFunction(i)}),obj});